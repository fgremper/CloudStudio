package ch.ethz.fgremper.rtca;

import java.sql.SQLException;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.json.JSONArray;
import org.json.JSONObject;

/**
 * Periodically calls the OriginUpdater 
 * @author Fabian Gremper
 */
public class PeriodicalAllOriginUpdater implements Runnable {

	private static final Logger log = LogManager.getLogger(PeriodicalAllOriginUpdater.class);
	
	public void run() {
		while (true) {
			
			log.info("Updating ");
			updateAll();
			
			// Sleep
			log.info("Waiting 10 seconds before updating origins again...");
			try {
				Thread.sleep(10000);
			}
			catch (InterruptedException ex) {
			    Thread.currentThread().interrupt();
			}
		}
	}
	
	public void updateAll() {
		DatabaseConnection db = null;
		try {
			db = new DatabaseConnection();
			JSONArray repositoriesArray = db.getAllRepositories();
			for (int i = 0; i < repositoriesArray.length(); i++) {
				JSONObject repositoryObject = repositoriesArray.getJSONObject(i);
				String repositoryAlias = repositoryObject.getString("repositoryAlias");
				String repositoryUrl = repositoryObject.getString("repositoryUrl");
				OriginUpdater.update(repositoryAlias, repositoryUrl);
			}
		}
		catch (Exception e) {
			e.printStackTrace();
		}
		
		// Close database connection
		try {
			if (db != null) {
				db.closeConnection();
			}
		}
		catch (SQLException e) {
			e.printStackTrace();
		}
	}
}
